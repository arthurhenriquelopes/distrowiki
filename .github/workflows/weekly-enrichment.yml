# DistroWiki - Weekly Data Enrichment
# Este workflow automatiza o enriquecimento semanal dos dados das distros
# Roda todo domingo Ã s 6h UTC (3h BrasÃ­lia)

name: Weekly Data Enrichment

on:
  schedule:
    # Todo domingo Ã s 6h UTC (3h da manhÃ£ no horÃ¡rio de BrasÃ­lia)
    - cron: '0 6 * * 0'
  
  # Permite rodar manualmente pelo GitHub Actions UI
  workflow_dispatch:
    inputs:
      enrichment_type:
        description: 'Tipo de enriquecimento'
        required: true
        default: 'all'
        type: choice
        options:
          - all            # Todas as distros
          - performance    # SÃ³ mÃ©tricas de performance (RAM, CPU, I/O)
          - dates          # SÃ³ datas de release

jobs:
  enrich-distros:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“‹ Log inÃ­cio do job
        run: |
          echo "ðŸš€ Iniciando enriquecimento semanal"
          echo "Data: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Trigger: ${{ github.event_name }}"
          echo "Tipo: ${{ github.event.inputs.enrichment_type || 'all' }}"

      # Step 1: Atualizar datas de release (via DistroWatch scraping)
      # SÃ³ roda se: all OU dates (NÃƒO roda se for performance)
      - name: ðŸ“… Atualizar datas de release
        if: ${{ github.event.inputs.enrichment_type != 'performance' }}
        run: |
          echo "ðŸ” Scraping datas de release do DistroWatch..."
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.API_BASE_URL }}/enrich-sheets/" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.API_KEY }}" \
            -d '{"fields": ["Latest Release"]}')
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "HTTP Code: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" -ne 200 ]; then
            echo "âŒ Falha ao atualizar datas"
            exit 1
          fi
          
          echo "âœ… Datas atualizadas com sucesso"

      # Step 2: Atualizar mÃ©tricas de performance em batches
      # SÃ³ roda se: all OU performance (NÃƒO roda se for dates)
      - name: ðŸ¤– Atualizar mÃ©tricas de performance (batch 1-5)
        if: ${{ github.event.inputs.enrichment_type != 'dates' }}
        run: |
          echo "ðŸ¤– Enriquecendo batch 1 (distros 0-4)..."
          curl -s -X POST "${{ secrets.API_BASE_URL }}/enrich-sheets/batch" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.API_KEY }}" \
            -d '{"offset": 0, "limit": 5, "fields": ["CPU Score", "I/O Score"]}'
          echo ""

      - name: ðŸ¤– Atualizar mÃ©tricas (batch 6-10)
        if: ${{ github.event.inputs.enrichment_type != 'dates' }}
        run: |
          sleep 5
          echo "ðŸ¤– Enriquecendo batch 2 (distros 5-9)..."
          curl -s -X POST "${{ secrets.API_BASE_URL }}/enrich-sheets/batch" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.API_KEY }}" \
            -d '{"offset": 5, "limit": 5, "fields": ["CPU Score", "I/O Score"]}'
          echo ""

      - name: ðŸ¤– Atualizar mÃ©tricas (batch 11-15)
        if: ${{ github.event.inputs.enrichment_type != 'dates' }}
        run: |
          sleep 5
          echo "ðŸ¤– Enriquecendo batch 3 (distros 10-14)..."
          curl -s -X POST "${{ secrets.API_BASE_URL }}/enrich-sheets/batch" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.API_KEY }}" \
            -d '{"offset": 10, "limit": 5, "fields": ["CPU Score", "I/O Score"]}'
          echo ""

      - name: ðŸ¤– Atualizar mÃ©tricas (batch 16-20)
        if: ${{ github.event.inputs.enrichment_type != 'dates' }}
        run: |
          sleep 5
          echo "ðŸ¤– Enriquecendo batch 4 (distros 15-19)..."
          curl -s -X POST "${{ secrets.API_BASE_URL }}/enrich-sheets/batch" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.API_KEY }}" \
            -d '{"offset": 15, "limit": 5, "fields": ["CPU Score", "I/O Score"]}'
          echo ""

      - name: ðŸ¤– Atualizar mÃ©tricas (batch 21-40)
        if: ${{ github.event.inputs.enrichment_type != 'dates' }}
        run: |
          for offset in 20 25 30 35; do
            sleep 5
            echo "ðŸ¤– Enriquecendo batch offset=$offset..."
            curl -s -X POST "${{ secrets.API_BASE_URL }}/enrich-sheets/batch" \
              -H "Content-Type: application/json" \
              -H "X-API-Key: ${{ secrets.API_KEY }}" \
              -d "{\"offset\": $offset, \"limit\": 5, \"fields\": [\"CPU Score\", \"I/O Score\"]}"
            echo ""
          done

      - name: ðŸ¤– Atualizar mÃ©tricas (batch 41-60)
        if: ${{ github.event.inputs.enrichment_type != 'dates' }}
        run: |
          for offset in 40 45 50 55; do
            sleep 5
            echo "ðŸ¤– Enriquecendo batch offset=$offset..."
            curl -s -X POST "${{ secrets.API_BASE_URL }}/enrich-sheets/batch" \
              -H "Content-Type: application/json" \
              -H "X-API-Key: ${{ secrets.API_KEY }}" \
              -d "{\"offset\": $offset, \"limit\": 5, \"fields\": [\"CPU Score\", \"I/O Score\"]}"
            echo ""
          done

      - name: ðŸ¤– Atualizar mÃ©tricas (batch 61-80)
        if: ${{ github.event.inputs.enrichment_type != 'dates' }}
        run: |
          for offset in 60 65 70 75; do
            sleep 5
            echo "ðŸ¤– Enriquecendo batch offset=$offset..."
            curl -s -X POST "${{ secrets.API_BASE_URL }}/enrich-sheets/batch" \
              -H "Content-Type: application/json" \
              -H "X-API-Key: ${{ secrets.API_KEY }}" \
              -d "{\"offset\": $offset, \"limit\": 5, \"fields\": [\"CPU Score\", \"I/O Score\"]}"
            echo ""
          done

      - name: ðŸ¤– Atualizar mÃ©tricas (batch 81-100)
        if: ${{ github.event.inputs.enrichment_type != 'dates' }}
        run: |
          for offset in 80 85 90 95; do
            sleep 5
            echo "ðŸ¤– Enriquecendo batch offset=$offset..."
            curl -s -X POST "${{ secrets.API_BASE_URL }}/enrich-sheets/batch" \
              -H "Content-Type: application/json" \
              -H "X-API-Key: ${{ secrets.API_KEY }}" \
              -d "{\"offset\": $offset, \"limit\": 5, \"fields\": [\"CPU Score\", \"I/O Score\"]}"
            echo ""
          done

      # Step 3: ForÃ§ar refresh do cache
      - name: ðŸ”„ Limpar cache da API
        run: |
          echo "ðŸ”„ ForÃ§ando refresh do cache..."
          
          curl -s -X GET \
            "${{ secrets.API_BASE_URL }}/distros?force_refresh=true" \
            -H "X-API-Key: ${{ secrets.API_KEY }}" > /dev/null || true
          
          echo "âœ… Cache invalidado"

      - name: âœ… Resumo
        run: |
          echo "========================================"
          echo "âœ… Enriquecimento semanal concluÃ­do!"
          echo "========================================"
          echo "Data: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Tipo executado: ${{ github.event.inputs.enrichment_type || 'all' }}"

# DistroWiki - Weekly Data Enrichment
# Este workflow automatiza o enriquecimento semanal dos dados das distros
# Roda todo domingo √†s 6h UTC (3h Bras√≠lia)

name: Weekly Data Enrichment

on:
  schedule:
    # Todo domingo √†s 6h UTC (3h da manh√£ no hor√°rio de Bras√≠lia)
    - cron: '0 6 * * 0'
  
  # Permite rodar manualmente pelo GitHub Actions UI
  workflow_dispatch:
    inputs:
      enrichment_type:
        description: 'Tipo de enriquecimento'
        required: true
        default: 'all'
        type: choice
        options:
          - all            # Todas as distros
          - performance    # S√≥ m√©tricas de performance
          - dates          # S√≥ datas de release

jobs:
  enrich-distros:
    runs-on: ubuntu-latest
    
    steps:
      - name: üìã Log in√≠cio do job
        run: |
          echo "üöÄ Iniciando enriquecimento semanal"
          echo "Data: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Trigger: ${{ github.event_name }}"

      # Step 1: Atualizar datas de release (via DistroWatch scraping)
      - name: üìÖ Atualizar datas de release
        run: |
          echo "üîç Scraping datas de release do DistroWatch..."
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.API_BASE_URL }}/enrich-sheets/" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.API_KEY }}" \
            -d '{"fields": ["Latest Release"]}')
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "HTTP Code: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" -ne 200 ]; then
            echo "‚ùå Falha ao atualizar datas"
            exit 1
          fi
          
          echo "‚úÖ Datas atualizadas com sucesso"

      # Step 2: Atualizar m√©tricas de performance (via Groq AI)
      - name: ü§ñ Atualizar m√©tricas de performance
        if: ${{ github.event.inputs.enrichment_type != 'dates' }}
        run: |
          echo "ü§ñ Enriquecendo m√©tricas via Groq AI..."
          
          response=$(curl -s -w "\n%{http_code}" -X POST \
            "${{ secrets.API_BASE_URL }}/enrich-sheets/" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.API_KEY }}" \
            -d '{"fields": ["Idle RAM Usage", "CPU Score", "I/O Score", "Requirements"]}')
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')
          
          echo "HTTP Code: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" -ne 200 ]; then
            echo "‚ö†Ô∏è Falha ao atualizar m√©tricas (n√£o cr√≠tico)"
          else
            echo "‚úÖ M√©tricas atualizadas com sucesso"
          fi

      # Step 3: For√ßar refresh do cache
      - name: üîÑ Limpar cache da API
        run: |
          echo "üîÑ For√ßando refresh do cache..."
          
          curl -s -X POST \
            "${{ secrets.API_BASE_URL }}/distros/refresh" \
            -H "X-API-Key: ${{ secrets.API_KEY }}" || true
          
          echo "‚úÖ Cache invalidado"

      - name: ‚úÖ Resumo
        run: |
          echo "========================================"
          echo "‚úÖ Enriquecimento semanal conclu√≠do!"
          echo "========================================"
          echo "Data: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

# DistroWiki - Weekly Data Enrichment
# Este workflow automatiza o enriquecimento semanal dos dados das distros
# Roda todo domingo Ã s 6h UTC (3h BrasÃ­lia)
# ATUALIZADO: Agora roda scraping diretamente no runner (nÃ£o via API)

name: Weekly Data Enrichment

on:
  schedule:
    # Todo domingo Ã s 6h UTC (3h da manhÃ£ no horÃ¡rio de BrasÃ­lia)
    - cron: '0 6 * * 0'
  
  # Permite rodar manualmente pelo GitHub Actions UI
  workflow_dispatch:
    inputs:
      enrichment_type:
        description: 'Tipo de enriquecimento'
        required: true
        default: 'dates'
        type: choice
        options:
          - dates          # SÃ³ datas de release (via DistroWatch scraping)
          - performance    # SÃ³ mÃ©tricas de performance (via API)
          - all            # Todas as distros

jobs:
  enrich-dates:
    # Job para atualizar datas via Playwright scraping
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.enrichment_type != 'performance' }}
    timeout-minutes: 90
    
    steps:
      - name: ðŸ“‹ Log inÃ­cio do job
        run: |
          echo "ðŸš€ Iniciando scraping de datas de release"
          echo "Data: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Trigger: ${{ github.event_name }}"
          echo "Tipo: ${{ github.event.inputs.enrichment_type || 'dates' }}"

      - name: ðŸ“¥ Checkout distrowiki-api
        uses: actions/checkout@v4
        with:
          repository: arthurhenriquelopes/distrowiki-api
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: ðŸ“¦ Instalar dependÃªncias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
      - name: ðŸŽ­ Instalar Playwright
        run: |
          pip install playwright
          playwright install chromium
          playwright install-deps chromium
          
      - name: ðŸ“… Scraping de datas de release
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        run: |
          echo "ðŸ” Iniciando DistroWatch scraping..."
          python scripts/enrich_distrowatch.py
          
      - name: âœ… Sucesso
        run: |
          echo "âœ… Scraping de datas concluÃ­do!"
          echo "Data: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

  enrich-performance:
    # Job para mÃ©tricas de performance (mantÃ©m API calls)
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.enrichment_type == 'performance' || github.event.inputs.enrichment_type == 'all' }}
    
    steps:
      - name: ðŸ“‹ Log inÃ­cio
        run: |
          echo "ðŸ¤– Iniciando enriquecimento de performance"
          
      - name: ðŸ¤– Atualizar mÃ©tricas em batches
        run: |
          for offset in 0 5 10 15 20 25 30 35 40 45 50 55 60 65 70 75 80 85 90 95; do
            echo "ðŸ¤– Batch offset=$offset..."
            curl -s -X POST "${{ secrets.API_BASE_URL }}/enrich-sheets/batch" \
              -H "Content-Type: application/json" \
              -H "X-API-Key: ${{ secrets.API_KEY }}" \
              -d "{\"offset\": $offset, \"limit\": 5, \"fields\": [\"CPU Score\", \"I/O Score\"]}" || true
            sleep 3
          done
          
      - name: ðŸ”„ Limpar cache
        run: |
          curl -s -X GET "${{ secrets.API_BASE_URL }}/distros?force_refresh=true" \
            -H "X-API-Key: ${{ secrets.API_KEY }}" > /dev/null || true
          echo "âœ… Cache invalidado"

  summary:
    runs-on: ubuntu-latest
    needs: [enrich-dates, enrich-performance]
    if: always()
    
    steps:
      - name: ðŸ“Š Resumo
        run: |
          echo "========================================"
          echo "âœ… Enriquecimento semanal concluÃ­do!"
          echo "========================================"
          echo "Data: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Jobs executados: dates=${{ needs.enrich-dates.result }}, perf=${{ needs.enrich-performance.result }}"
